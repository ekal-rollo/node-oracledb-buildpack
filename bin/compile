#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

indent() { 
    echo "       $*" || true
}

VENDOR_DIR=$BUILD_DIR/vendor
ORACLE_DIR=$VENDOR_DIR/oracle
INSTANTCLIENT_DIR=$ORACLE_DIR/instantclient_21_1
PROFILE_D_DIR=$BUILD_DIR/.profile.d

BASIC_FILENAME=instantclient-basic-linuxx64.zip
SDK_FILENAME=instantclient-sdk-linuxx64.zip
SQL_PLUS_FILENAME=instantclient-sqlplus-linuxx64.zip
ODBC_FILENAME=instantclient-odbc-linuxx64.zip
JDBC_SUPPLIMENT=instantclient-jdbc-linuxx64.zip

MIRROR=https://download.oracle.com/otn_software/linux/instantclient/


mkdir -p $ORACLE_DIR

if [ ! -f $ORACLE_DIR/$BASIC_FILENAME ]; then
    indent "Downloading $BASIC_FILENAME..."
    curl -# -o $ORACLE_DIR/$BASIC_FILENAME $MIRROR/$BASIC_FILENAME
    indent "Extracting $BASIC_FILENAME..."
    unzip -qq $ORACLE_DIR/$BASIC_FILENAME -d $ORACLE_DIR
fi

if [ ! -f $ORACLE_DIR/$SDK_FILENAME ]; then
    indent "Downloading $SDK_FILENAME..."
    curl -# -o $ORACLE_DIR/$SDK_FILENAME $MIRROR/$SDK_FILENAME
    indent "Extracting $SDK_FILENAME..."
    unzip -qq $ORACLE_DIR/$SDK_FILENAME -d $ORACLE_DIR
fi

if [ ! -f $ORACLE_DIR/$SQL_PLUS_FILENAME ]; then
    indent "Downloading $SQL_PLUS_FILENAME..."
    curl -# -o $ORACLE_DIR/$SQL_PLUS_FILENAME $MIRROR/$SQL_PLUS_FILENAME
    indent "Extracting $SQL_PLUS_FILENAME..."
    unzip -qq $ORACLE_DIR/$SQL_PLUS_FILENAME -d $ORACLE_DIR
fi

indent "Symlinking libclntsh.so.21.1"
echo "INSTANT CLIENT DIRECTORY: " $INSTANTCLIENT_DIR
cd $INSTANTCLIENT_DIR
ln -s libclntsh.so.21.1 libclntsh.so
ln -s libocci.so.21.1 libocci.so
export PATH=/opt/oracle/instantclient_21_1:$PATH
export OCI_LIB_DIR=$INSTANTCLIENT_DIR
export OCI_INC_DIR=$INSTANTCLIENT_DIR/sdk/include
export LD_LIBRARY_PATH=$INSTANTCLIENT_DIR:$LD_LIBRARY_PATH

echo $LD_LIBRARY_PATH
sqlplus
indent "Done."